@* 
    Project: Aguafrommars/TheIdServer
    Copyright (c) 2025 @Olivier Lefebvre

    -----------------------------------------------------------------------------
    Consent Page View

    This Razor view renders the consent page for OAuth/OpenID Connect flows.
    It displays the client requesting permissions, the scopes being requested,
    and allows the user to grant or deny consent. The view supports localization
    and dynamic rendering of client information, requested scopes, and policy links.

    Model: ConsentViewModel
        - ClientLogoUrl: string? - URL of the requesting client's logo.
        - ClientName: string - Name of the requesting client.
        - IdentityScopes: IEnumerable<ScopeViewModel>? - Personal information scopes.
        - ApiScopes: IEnumerable<ScopeViewModel>? - Application access scopes.
        - AllowRememberConsent: bool - Whether the user can remember their decision.
        - ClientUrl: string? - URL to client information.
        - PolicyUrl: string? - URL to privacy policy.
        - TosUrl: string? - URL to terms of service.
        - ReturnUrl: string - URL to return after consent.
        - RememberConsent: bool - Indicates if consent should be remembered.

    Localization: Uses IViewLocalizer for all user-facing text.

    UI Elements:
        - Client logo and name
        - Validation summary
        - List of requested scopes (personal and application)
        - Remember consent checkbox
        - Consent buttons (Allow, Do Not Allow)
        - Links to client info, policy, and terms of service

    -----------------------------------------------------------------------------
*@

@inject IViewLocalizer Localizer

@model ConsentViewModel

<div class="page-consent">
    <div class="row page-header">
        <div class="col-sm-10">
            @* Display client logo if available *@
            @if (Model.ClientLogoUrl != null)
            {
                <div class="client-logo"><img src="@Model.ClientLogoUrl" alt="logo"></div>
            }
            <h1>
                @* Display client name and consent request message *@
                @Localizer["{0} <small>is requesting your permission</small>", @Model.ClientName!]
            </h1>
        </div>
    </div>

    <div class="row">
        <div class="col-sm-8">
            @* Display validation summary for form errors *@
            <partial name="_ValidationSummary" />

            <form asp-action="Index" class="consent-form">
                @* Hidden field for return URL after consent *@
                <input type="hidden" asp-for="ReturnUrl" />

                <div>@Localizer["Uncheck the permissions you do not wish to grant."]</div>

                @* Render identity scopes if available *@
                @if (Model.IdentityScopes?.Any() == true)
                {
                    <div class="panel panel-default consent-buttons">
                        <div class="panel-heading">
                            <span class="glyphicon glyphicon-user"></span>
                            @Localizer["Personal Information"]
                        </div>
                        <ul class="list-group">
                            @foreach (var scope in Model.IdentityScopes)
                            {
                                <partial name="_ScopeListItem" model="@scope" />
                            }
                        </ul>
                    </div>
                }

                @* Render API scopes if available *@
                @if (Model.ApiScopes?.Any() == true)
                {
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <span class="glyphicon glyphicon-tasks"></span>
                            @Localizer["Application Access"]
                        </div>
                        <ul class="list-group">
                            @foreach (var scope in Model.ApiScopes)
                            {
                                <partial name="_ScopeListItem" model="scope" />
                            }
                        </ul>
                    </div>
                }

                @* Option to remember consent decision *@
                @if (Model.AllowRememberConsent)
                {
                    <div class="consent-remember">
                        <label>
                            <input class="consent-scopecheck" asp-for="RememberConsent" />
                            <strong>@Localizer["Remember My Decision"]</strong>
                        </label>
                    </div>
                }

                @* Consent action buttons *@
                <div class="consent-buttons">
                    <button name="button" value="yes" class="btn btn-primary" autofocus>@Localizer["Yes, Allow"]</button>
                    <button name="button" value="no" class="btn">@Localizer["No, Do Not Allow"]</button>
                    @* Link to client information if available *@
                    @if (Model.ClientUrl != null)
                    {
                        <a class="pull-right btn btn-secondary" target="_blank" href="@Model.ClientUrl" rel="noopener noreferrer">
                            <span class="glyphicon glyphicon-info-sign"></span>
                            <strong>@Model.ClientName</strong>
                        </a>
                    }
                </div>
                <div class="consent-buttons">
                    @* Link to privacy policy if available *@
                    @if (Model.PolicyUrl != null)
                    {
                        <div>
                            <a target="_blank" href="@Model.PolicyUrl" rel="noopener noreferrer">
                                @Localizer["Policy"]
                            </a>
                        </div>
                    }
                    @* Link to terms of service if available *@
                    @if (Model.TosUrl != null)
                    {
                        <a target="_blank" href="@Model.TosUrl" rel="noopener noreferrer">
                            @Localizer["Terms of service"]
                        </a>
                    }
                </div>
            </form>
        </div>
    </div>
</div>