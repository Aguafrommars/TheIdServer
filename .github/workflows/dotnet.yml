name: .NET

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:  
  
jobs:
  setup:
    runs-on: ubuntu-latest
    
    steps:
    - name: Create mongo Docker container
      uses: DigiPie/mongo-action@v1.0.1
      
  build:
    needs: setup
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v2
    - name: Setup .NET 5.0.x
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 5.0.x
    - name: Setup .NET 6.0.x
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 6.0.x
    - name: Setup NuGet.exe for use with actions
      uses: NuGet/setup-nuget@v1.0.5
    - name: Install Redis
      run: nuget install redis-64 -excludeversion
    - name: Setup Redis service
      run: redis-64\tools\redis-server.exe --service-install
    - name: Start Redis service
      run: redis-64\tools\redis-server.exe --service-start
    - name: Install WASM tools
      run: dotnet workload install wasm-tools
    - name: Install Sonar Scanner
      run: dotnet tool install --global dotnet-sonarscanner
    - name: Start Sonar Scanner
      run: dotnet sonarscanner begin /k:aguacongas_TheIdServer -o:aguacongas -d:sonar.host.url=https://sonarcloud.io -d:sonar.login=${{ secrets.SQToken }}
    - name: Restore dependencies
      run: dotnet restore
    - name: Build
      run: dotnet build -c Release --no-restore
    - name: Test
      run: dotnet test -c Release --no-build --verbosity normal
    - name: Stop Sonar Scanner
      run: dotnet sonarscanner end -d:sonar.login=${{ secrets.SQToken }}
